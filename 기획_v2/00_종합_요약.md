# 마그네틱 세일즈 웹앱 - 기획 v2 종합 요약

## 문서 정보
| 항목 | 내용 |
|------|------|
| 버전 | 2.0 (Final) |
| 작성일 | 2025-12-15 |
| 작성자 | 기획팀 |
| 상태 | Red Team / Blue Team 최종 승인 완료 |
| 문서 번호 | 00_종합_요약 |

---

## 1. 프로젝트 개요

### 1.1 제품 비전
**"AI 기반 마그네틱 세일즈 랜딩페이지 자동 생성 서비스"**

비개발자도 40개 질문에 답변하면, AI가 전환율 높은 마그네틱 세일즈 랜딩페이지를 자동으로 생성해주는 SaaS 서비스

### 1.2 핵심 가치
| 가치 | 설명 |
|------|------|
| 간편함 | 복잡한 기술 지식 없이 질문 답변만으로 완성 |
| 효과성 | 검증된 마그네틱 세일즈 18단계 프레임워크 적용 |
| 경제성 | 전문 카피라이터 대비 90% 이상 비용 절감 |
| 보안성 | 엔터프라이즈급 보안 아키텍처 (v2) |

### 1.3 타겟 사용자
- 1인 창업자 / 프리랜서
- 소규모 비즈니스 운영자
- 마케터 / 세일즈 담당자
- 코칭/컨설팅 서비스 제공자

---

## 2. v1 vs v2 상세 비교표

### 2.1 보안 아키텍처 비교

| 영역 | v1 설계 | v1 문제점 | v2 해결책 | 중요도 |
|------|---------|-----------|-----------|--------|
| **CORS** | 와일드카드 (`*`) 허용 | Origin 스푸핑, CSRF 취약 | 명시적 도메인 화이트리스트 + Sec-Fetch-Site 검증 | CRITICAL |
| **AI 토큰** | 단순 차감 방식 | Race Condition으로 음수 토큰 가능 | PostgreSQL Advisory Lock (`pg_advisory_xact_lock`) | CRITICAL |
| **세션 관리** | 상태 변경 시 미무효화 | 승인 취소 후에도 서비스 이용 가능 | `approval_changed_at` 기반 전체 세션 무효화 | CRITICAL |
| **삭제 방식** | 물리적 삭제 (Hard Delete) | 실수 복구 불가, 감사 불가 | Soft Delete (`deleted_at`) + 30일 복구 기간 | CRITICAL |
| **JWT 저장** | localStorage | XSS 공격 시 토큰 탈취 | HttpOnly Cookie (Refresh Token) | HIGH |
| **Refresh Token** | 단순 재발급 | 토큰 탈취 시 무제한 사용 | Rotation + 재사용 감지 | HIGH |
| **SQL Injection** | RPC 호출 | 동적 쿼리 취약 | Supabase SDK 직접 사용 + Zod 검증 | HIGH |
| **XSS 방어** | 기본 DOMPurify | `javascript:` URI 미차단 | ALLOWED_URI_REGEXP 강화 | HIGH |
| **Rate Limiting** | Upstash Redis | 외부 의존성, 지연 | Supabase PostgreSQL 기반 | HIGH |
| **Prompt Injection** | 단일 레이어 (시스템 프롬프트) | 우회 가능 | 다중 레이어 방어 (입력/시스템/출력) | HIGH |
| **감사 로그** | 미구현 | 보안 사고 추적 불가 | `audit_logs` + `security_events` 테이블 | HIGH |
| **RLS 정책** | 기본 정책 | Soft Delete 미고려 | `deleted_at IS NULL` 조건 추가 | MEDIUM |

### 2.2 기능 비교

| 기능 | v1 | v2 | 변경 내용 |
|------|----|----|----------|
| 회원가입 | Supabase Auth 기본 | + 수동 승인 + 승인 알림 | 승인 상태 관리 강화 |
| 로그인 | JWT localStorage | HttpOnly Cookie | 보안 강화 |
| 토큰 갱신 | 자동 갱신 | + Rotation + 재사용 감지 | 세션 하이재킹 방지 |
| 로그아웃 | 단일 세션 | + 전체 로그아웃 옵션 | 보안 옵션 추가 |
| AI 생성 | 단순 호출 | + Advisory Lock + 2-Phase 토큰 | Race Condition 방지 |
| 랜딩페이지 삭제 | Hard Delete | Soft Delete + 복구 | 실수 복구 가능 |
| 랜딩페이지 복구 | 없음 | 30일 이내 복구 | 신규 기능 |
| 감사 로그 | 없음 | 전체 이벤트 로깅 | 신규 기능 |
| Rate Limiting | 기본 | 엔드포인트별 차등 | 세분화 |

### 2.3 데이터베이스 비교

| 테이블 | v1 | v2 | 변경 내용 |
|--------|----|----|----------|
| `profiles` | 기본 필드 | + `deleted_at`, `approval_changed_at` | Soft Delete, 세션 관리 |
| `landing_pages` | 기본 필드 | + `deleted_at` | Soft Delete |
| `landing_page_versions` | 없음 | 신규 | 버전 관리 |
| `conversations` | 기본 필드 | + `deleted_at` | Soft Delete |
| `messages` | 기본 필드 | 변경 없음 | - |
| `refresh_tokens` | 없음 | 신규 | Token Rotation |
| `audit_logs` | 없음 | 신규 | 감사 로그 |
| `security_events` | 없음 | 신규 | 보안 이벤트 |
| `rate_limits` | 없음 | 신규 | Rate Limiting |
| `ai_usage_logs` | 기본 | + `reserved_at`, `confirmed_at` | 2-Phase 토큰 |

### 2.4 API 비교

| 엔드포인트 | v1 | v2 | 변경 내용 |
|-----------|----|----|----------|
| `POST /api/auth/login` | JWT 반환 | + HttpOnly Cookie | 저장 방식 변경 |
| `POST /api/auth/refresh` | 단순 갱신 | + Rotation | 보안 강화 |
| `POST /api/auth/logout-all` | 없음 | 신규 | 전체 로그아웃 |
| `DELETE /api/lp/:id` | Hard Delete | Soft Delete | 복구 가능 |
| `POST /api/lp/:id/restore` | 없음 | 신규 | 복구 기능 |
| `DELETE /api/lp/:id/permanent` | 없음 | 신규 | 완전 삭제 |

### 2.5 보안 정책 비교

| 정책 | v1 | v2 |
|------|----|----|
| Access Token 만료 | 1시간 | 15분 |
| Refresh Token 만료 | 7일 | 7일 |
| Refresh Token 저장 | localStorage | HttpOnly Cookie |
| Token Rotation | 없음 | 적용 (재사용 감지) |
| CORS Origin | `*` (와일드카드) | 명시적 화이트리스트 |
| Rate Limit 방식 | Upstash Redis | PostgreSQL |
| Prompt Injection 방어 | 시스템 프롬프트 1개 | 3레이어 (입력/시스템/출력) |
| 삭제 데이터 복구 | 불가능 | 30일 이내 가능 |
| 감사 로그 | 없음 | 전체 이벤트 기록 |

---

## 3. 기술 스택

### 3.1 프론트엔드
```yaml
Framework: Next.js 14 (App Router)
Language: TypeScript 5.x
Styling: Tailwind CSS 3.x
State: Zustand
Validation: Zod
Rich Text: TipTap Editor
Sanitization: DOMPurify (v2 강화 설정)
```

### 3.2 백엔드
```yaml
BaaS: Supabase
Database: PostgreSQL 15
Auth: Supabase Auth + Manual Approval
Storage: Supabase Storage
Edge Functions: Supabase Edge Functions (Deno)
Rate Limiting: PostgreSQL 기반 (v2 변경)
```

### 3.3 AI
```yaml
Provider: Anthropic Claude API
Model: claude-3-5-sonnet-20241022
Token Management: 2-Phase (Reserved -> Confirmed)
Prompt Injection Defense: Multi-Layer (v2)
```

### 3.4 인프라
```yaml
Hosting: Vercel
CDN: Vercel Edge Network
Monitoring: Vercel Analytics
Error Tracking: Sentry
Security Alerts: Slack Webhook
```

---

## 4. 핵심 기능 (MVP)

### 4.1 기능 매트릭스

| 기능 | 설명 | v2 상태 | 우선순위 |
|------|------|---------|----------|
| 회원가입/로그인 | Supabase Auth + 수동 승인 | 완료 | P0 |
| JWT Token Rotation | HttpOnly Cookie + Rotation | 완료 | P0 |
| AI 질문/답변 | 40개 질문 단계별 진행 | 완료 | P0 |
| 랜딩페이지 생성 | DESIRE-MAGNETIC 공식 적용 | 완료 | P0 |
| 랜딩페이지 편집 | WYSIWYG 에디터 | 완료 | P0 |
| 미리보기/배포 | 고유 URL 생성 | 완료 | P0 |
| 대시보드 | 생성 이력, 토큰 사용량 | 완료 | P0 |
| Soft Delete + 복구 | 30일 이내 복구 가능 | 완료 | P1 |
| 감사 로그 | 전체 이벤트 기록 | 완료 | P1 |
| Rate Limiting | PostgreSQL 기반 | 완료 | P1 |
| Prompt Injection 방어 | 다중 레이어 | 완료 | P1 |

### 4.2 사용자 등급별 기능

| 등급 | 일일 토큰 | 랜딩페이지 수 | 가격 | v2 변경 |
|------|----------|--------------|------|---------|
| FREE | 100,000 | 3개 | 무료 | 50,000 -> 100,000 상향 |
| PRO | 500,000 | 무제한 | $29/월 | 변경 없음 |
| ENTERPRISE | 2,000,000 | 무제한 | $99/월 | 변경 없음 |

---

## 5. 데이터베이스 스키마 요약 (v2)

### 5.1 테이블 목록

| 테이블명 | 설명 | v2 변경 사항 |
|----------|------|-------------|
| `profiles` | 사용자 프로필 | `deleted_at`, `approval_changed_at` 추가 |
| `refresh_tokens` | Refresh Token 관리 | **신규** (Token Rotation) |
| `conversations` | AI 대화 세션 | `deleted_at` 추가 |
| `messages` | 대화 메시지 | 변경 없음 |
| `landing_pages` | 랜딩페이지 | `deleted_at` 추가 |
| `landing_page_versions` | 버전 관리 | **신규** |
| `ai_usage_logs` | AI 토큰 사용량 | `reserved_at`, `confirmed_at` 추가 |
| `rate_limits` | Rate Limit 카운터 | **신규** |
| `audit_logs` | 감사 로그 | **신규** |
| `security_events` | 보안 이벤트 | **신규** |
| `page_views` | 페이지뷰 통계 | 변경 없음 |

### 5.2 ER 다이어그램 (간략)

```
profiles (1) ----< (N) landing_pages
    |
    +----< (N) refresh_tokens
    |
    +----< (N) conversations ----< (N) messages
    |
    +----< (N) ai_usage_logs
    |
    +----< (N) audit_logs
```

---

## 6. API 엔드포인트 요약 (v2)

### 6.1 인증 API

| Method | Endpoint | 설명 | v2 변경 |
|--------|----------|------|---------|
| POST | `/api/auth/signup` | 회원가입 | - |
| POST | `/api/auth/login` | 로그인 | HttpOnly Cookie 발급 |
| POST | `/api/auth/refresh` | 토큰 갱신 | Token Rotation |
| POST | `/api/auth/logout` | 로그아웃 | 세션 무효화 |
| POST | `/api/auth/logout-all` | 전체 로그아웃 | **신규** |

### 6.2 AI API

| Method | Endpoint | 설명 | v2 변경 |
|--------|----------|------|---------|
| POST | `/api/ai/chat` | AI 대화 | Advisory Lock |
| POST | `/api/ai/generate-prompt` | 프롬프트 생성 | Advisory Lock |
| POST | `/api/ai/generate-html` | HTML 생성 | Advisory Lock |
| GET | `/api/ai/usage` | 토큰 사용량 | - |

### 6.3 랜딩페이지 API

| Method | Endpoint | 설명 | v2 변경 |
|--------|----------|------|---------|
| GET | `/api/lp` | 목록 조회 | Soft Delete 필터 |
| POST | `/api/lp` | 생성 | - |
| GET | `/api/lp/:id` | 상세 조회 | - |
| PATCH | `/api/lp/:id` | 수정 | - |
| DELETE | `/api/lp/:id` | 삭제 | Soft Delete |
| POST | `/api/lp/:id/restore` | 복구 | **신규** |
| DELETE | `/api/lp/:id/permanent` | 완전 삭제 | **신규** |
| POST | `/api/lp/:id/publish` | 발행 | - |

---

## 7. 보안 체크리스트 (v2)

### 7.1 CRITICAL (4개) - 모두 해결됨

| ID | 이슈 | 해결책 | 상태 |
|----|------|--------|------|
| CRITICAL-API-001 | CORS 와일드카드 | 명시적 화이트리스트 + Sec-Fetch-Site 검증 | 해결됨 |
| CRITICAL-API-003 | AI 토큰 Race Condition | PostgreSQL Advisory Lock | 해결됨 |
| CRITICAL-UX-001 | 세션 관리 미흡 | approval_changed_at 기반 무효화 | 해결됨 |
| CRITICAL-DB-001 | Hard Delete | Soft Delete + 30일 복구 | 해결됨 |

### 7.2 HIGH (8개) - 모두 해결됨

| ID | 이슈 | 해결책 | 상태 |
|----|------|--------|------|
| HIGH-SEC-001 | JWT localStorage | HttpOnly Cookie + Rotation | 해결됨 |
| HIGH-SEC-002 | SQL Injection | Supabase SDK + Zod | 해결됨 |
| HIGH-SEC-003 | XSS 취약 | DOMPurify ALLOWED_URI_REGEXP | 해결됨 |
| HIGH-UX-001 | Rate Limiting | PostgreSQL 기반 | 해결됨 |
| HIGH-AI-001 | Prompt Injection | 다중 레이어 방어 | 해결됨 |
| HIGH-DB-001 | 감사 로그 미구현 | audit_logs 테이블 | 해결됨 |
| HIGH-AUTH-001 | Token 탈취 위험 | Refresh Token Rotation | 해결됨 |
| HIGH-AUTH-002 | 세션 무효화 미흡 | 트리거 기반 자동 무효화 | 해결됨 |

---

## 8. 구현 일정

### 8.1 Phase별 일정

| Phase | 기간 | 주요 작업 |
|-------|------|----------|
| Phase 1 | 1주차 | CORS, JWT Cookie, Token Rotation, Rate Limiting |
| Phase 2 | 2주차 | Soft Delete, 신규 테이블, RLS 업데이트, Advisory Lock |
| Phase 3 | 3주차 | Prompt Injection 방어, 2-Phase 토큰, 출력 검증 |
| Phase 4 | 4주차 | 보안 테스트, 성능 테스트, UAT, 문서화 |

### 8.2 예상 일정

| 구분 | 예상 기간 |
|------|----------|
| Red Team 추정 | 32일 |
| Blue Team 추정 | 18.5일 |
| **합의 일정** | **25일** (버퍼 포함) |

---

## 9. 문서 목록

### 9.1 기획 v2 문서

| 번호 | 파일명 | 설명 |
|------|--------|------|
| 00 | 00_종합_요약.md | 전체 요약, v1 vs v2 비교 (본 문서) |
| 01 | 01_UX_플로우_v2.md | 사용자 여정, 와이어프레임 |
| 02 | 02_기능_정의_v2.md | 상세 기능 명세 |
| 03 | 03_DB_설계_v2.md | 스키마, RLS, 마이그레이션 |
| 04 | 04_API_설계_v2.md | 엔드포인트, 요청/응답 |
| 05 | 05_AI_프롬프트_설계_v2.md | 프롬프트, 토큰 관리 |
| 06 | 06_보안_인증_v2.md | 인증, Token Rotation, 세션 관리 |
| 07 | 07_보안_아키텍처_v2.md | 보안 정책, CORS, XSS |

### 9.2 리뷰 문서

| 파일명 | 설명 |
|--------|------|
| 01_RedTeam_보안리뷰.md | Red Team 보안 리뷰 결과 |
| 02_BlueTeam_응답.md | Blue Team 1차 응답 |
| 03_RedTeam_2차_리뷰.md | Red Team 2차 리뷰 |
| 04_BlueTeam_개선안_v2.md | Blue Team 최종 개선안 |
| 05_최종_합의.md | Red/Blue Team 최종 합의 |

---

## 10. 승인 이력

| 일자 | 버전 | 검토자 | 결과 | 비고 |
|------|------|--------|------|------|
| 2025-12-10 | v1.0 | Red Team | 조건부 승인 | 42개 이슈 발견 |
| 2025-12-12 | v1.5 | Blue Team | 개선안 제출 | 35개 해결 |
| 2025-12-13 | v1.5 | Red Team | 재검토 | 4개 CRITICAL 미해결 |
| 2025-12-14 | v2.0 | Blue Team | 최종 개선 | 23개 피드백 반영 |
| 2025-12-15 | v2.0 | Red Team | **최종 승인** | 모든 CRITICAL 해결 |

---

## 부록 A: 용어 정의

| 용어 | 정의 |
|------|------|
| 마그네틱 세일즈 | 고객을 자석처럼 끌어당기는 세일즈 기법 |
| DESIRE-MAGNETIC | 랜딩페이지 구조 공식 (욕구 자극 + 마그네틱) |
| Triple-Magnetic | 3중 마그네틱 시스템 (헤드라인/스토리/오퍼) |
| Advisory Lock | PostgreSQL의 애플리케이션 레벨 잠금 |
| Refresh Token Rotation | 토큰 갱신 시 새 토큰 발급 및 이전 토큰 폐기 |
| Soft Delete | 실제 삭제 대신 삭제 표시 (복구 가능) |
| RLS | Row Level Security (행 단위 보안) |
| Prompt Injection | AI 시스템에 악성 프롬프트를 주입하는 공격 |
| 2-Phase Token | 예약(Reserved) -> 확정(Confirmed) 2단계 토큰 관리 |

---

## 부록 B: 변경 로그

### v2.0 (2025-12-15) - 최종 버전

**보안 강화**
- CORS 와일드카드 제거 및 Sec-Fetch-Site 검증 추가
- JWT HttpOnly Cookie + Refresh Token Rotation 구현
- PostgreSQL Advisory Lock으로 토큰 Race Condition 해결
- Prompt Injection 다중 레이어 방어 구현 (입력/시스템/출력)
- Supabase PostgreSQL 기반 Rate Limiting으로 전환

**데이터 관리**
- Soft Delete 패턴 전체 적용 (`deleted_at` 컬럼)
- 30일 이내 복구 기능 추가
- 감사 로그 테이블 (`audit_logs`) 추가
- 보안 이벤트 테이블 (`security_events`) 추가

**세션 관리**
- `approval_changed_at` 기반 세션 무효화
- 승인 상태 변경 시 자동 세션 종료 트리거
- 비밀번호 변경 시 모든 세션 폐기

**API 변경**
- `POST /api/lp/:id/restore` - 삭제 복구 (신규)
- `DELETE /api/lp/:id/permanent` - 완전 삭제 (신규)
- `POST /api/auth/logout-all` - 전체 로그아웃 (신규)

### v1.0 (2025-12-08) - 초기 버전

- 초기 기획 문서 작성
- MVP 기능 정의
- 기본 아키텍처 설계
- Supabase Auth 기반 인증 설계
- Claude API 연동 설계

---

## 부록 C: 기획 v2 문서 구조

```
magnetic-sales-webapp/
├── 기획_v2/
│   ├── 00_종합_요약.md           # 본 문서 (v1 vs v2 비교 포함)
│   ├── 01_UX_플로우_v2.md        # 사용자 여정, 화면 설계
│   ├── 02_기능_정의_v2.md        # 상세 기능 명세
│   ├── 03_DB_설계_v2.md          # 데이터베이스 스키마
│   ├── 04_API_설계_v2.md         # API 엔드포인트
│   ├── 05_AI_프롬프트_설계_v2.md # AI 프롬프트, 토큰 관리
│   ├── 06_보안_인증_v2.md        # 인증, Token Rotation
│   └── 07_보안_아키텍처_v2.md    # 보안 정책, CORS, XSS
├── 리뷰/
│   ├── 01_RedTeam_보안리뷰.md
│   ├── 02_BlueTeam_응답.md
│   ├── 03_RedTeam_2차_리뷰.md
│   ├── 04_BlueTeam_개선안_v2.md
│   └── 05_최종_합의.md
└── 기획_v1/                      # 이전 버전 (참조용)
    └── ...
```

---

**문서 끝**

*이 문서는 마그네틱 세일즈 웹앱 기획 v2의 최종 종합 요약입니다.*
*모든 CRITICAL 이슈가 해결되었으며, Red Team / Blue Team 최종 승인을 받았습니다.*
