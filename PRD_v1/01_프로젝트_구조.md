# Magnetic Sales WebApp - 프로젝트 구조

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서 버전 | 1.0 |
| 작성일 | 2025-12-15 |
| 이전 문서 | [00_PRD_개요.md](./00_PRD_개요.md) |
| 다음 문서 | [02_DB_마이그레이션.md](./02_DB_마이그레이션.md) |

---

## 1. 디렉토리 구조

### 1.1 전체 프로젝트 구조

```
magnetic-sales-webapp/
├── .github/
│   └── workflows/
│       ├── ci.yml                    # CI 파이프라인
│       ├── cd.yml                    # CD 파이프라인
│       └── security-scan.yml         # 보안 스캔
├── .husky/
│   ├── pre-commit                    # 커밋 전 린트/타입체크
│   └── pre-push                      # 푸시 전 테스트
├── public/
│   ├── favicon.ico
│   ├── logo.svg
│   └── og-image.png                  # Open Graph 이미지
├── src/
│   ├── app/                          # Next.js App Router
│   ├── components/                   # React 컴포넌트
│   ├── hooks/                        # 커스텀 훅
│   ├── lib/                          # 유틸리티, 헬퍼
│   ├── store/                        # Zustand 스토어
│   ├── types/                        # TypeScript 타입
│   └── styles/                       # 글로벌 스타일
├── supabase/
│   ├── migrations/                   # DB 마이그레이션
│   ├── seed/                         # 시드 데이터
│   └── functions/                    # Edge Functions
├── tests/
│   ├── unit/                         # 단위 테스트
│   ├── integration/                  # 통합 테스트
│   └── e2e/                          # E2E 테스트
├── docs/                             # 프로젝트 문서
├── .env.example                      # 환경변수 예시
├── .env.local                        # 로컬 환경변수 (gitignore)
├── .eslintrc.json                    # ESLint 설정
├── .prettierrc                       # Prettier 설정
├── next.config.js                    # Next.js 설정
├── tailwind.config.ts                # Tailwind 설정
├── tsconfig.json                     # TypeScript 설정
├── package.json
└── README.md
```

### 1.2 src/app 구조 (App Router)

```
src/app/
├── (auth)/                           # 인증 그룹 (레이아웃 공유)
│   ├── login/
│   │   └── page.tsx
│   ├── signup/
│   │   └── page.tsx
│   ├── forgot-password/
│   │   └── page.tsx
│   └── layout.tsx                    # 인증 페이지 레이아웃
├── (dashboard)/                      # 대시보드 그룹
│   ├── dashboard/
│   │   └── page.tsx
│   ├── landing-pages/
│   │   ├── page.tsx                  # 목록
│   │   ├── new/
│   │   │   └── page.tsx              # 새 랜딩페이지 생성
│   │   ├── [id]/
│   │   │   ├── page.tsx              # 상세/편집
│   │   │   └── preview/
│   │   │       └── page.tsx          # 미리보기
│   │   └── deleted/
│   │       └── page.tsx              # 삭제된 항목 (복구용)
│   ├── qa-session/
│   │   ├── page.tsx                  # Q&A 세션 시작
│   │   └── [id]/
│   │       └── page.tsx              # 진행 중인 세션
│   ├── settings/
│   │   ├── page.tsx                  # 설정 메인
│   │   ├── profile/
│   │   │   └── page.tsx
│   │   └── security/
│   │       └── page.tsx              # 보안 설정 (세션 관리)
│   └── layout.tsx                    # 대시보드 레이아웃
├── (public)/                         # 공개 페이지 그룹
│   ├── lp/
│   │   └── [slug]/
│   │       └── page.tsx              # 발행된 랜딩페이지
│   └── layout.tsx
├── api/                              # API Routes
│   ├── auth/
│   │   ├── signup/
│   │   │   └── route.ts
│   │   ├── login/
│   │   │   └── route.ts
│   │   ├── logout/
│   │   │   └── route.ts
│   │   ├── logout-all/
│   │   │   └── route.ts
│   │   └── refresh/
│   │       └── route.ts
│   ├── ai/
│   │   ├── chat/
│   │   │   └── route.ts
│   │   ├── generate/
│   │   │   └── route.ts
│   │   └── tokens/
│   │       └── route.ts
│   ├── lp/
│   │   ├── route.ts                  # GET (목록), POST (생성)
│   │   ├── deleted/
│   │   │   └── route.ts              # GET (삭제된 목록)
│   │   └── [id]/
│   │       ├── route.ts              # GET, PATCH, DELETE
│   │       ├── restore/
│   │       │   └── route.ts          # POST (복구)
│   │       └── publish/
│   │           └── route.ts          # POST (발행)
│   └── admin/
│       ├── users/
│       │   └── [id]/
│       │       ├── approve/
│       │       │   └── route.ts
│       │       └── route.ts
│       └── audit-logs/
│           └── route.ts
├── layout.tsx                        # 루트 레이아웃
├── page.tsx                          # 홈페이지 (리다이렉트)
├── loading.tsx                       # 로딩 UI
├── error.tsx                         # 에러 UI
├── not-found.tsx                     # 404 페이지
└── globals.css                       # 글로벌 CSS
```

### 1.3 src/components 구조

```
src/components/
├── ui/                               # 기본 UI 컴포넌트
│   ├── Button/
│   │   ├── Button.tsx
│   │   ├── Button.test.tsx
│   │   └── index.ts
│   ├── Input/
│   │   ├── Input.tsx
│   │   ├── Input.test.tsx
│   │   └── index.ts
│   ├── Modal/
│   │   ├── Modal.tsx
│   │   ├── Modal.test.tsx
│   │   └── index.ts
│   ├── Card/
│   │   └── ...
│   ├── Toast/
│   │   └── ...
│   ├── Spinner/
│   │   └── ...
│   ├── Badge/
│   │   └── ...
│   └── index.ts                      # 배럴 export
├── forms/                            # 폼 컴포넌트
│   ├── LoginForm/
│   │   ├── LoginForm.tsx
│   │   ├── LoginForm.test.tsx
│   │   └── index.ts
│   ├── SignupForm/
│   │   └── ...
│   ├── QAForm/
│   │   ├── QAForm.tsx
│   │   ├── QuestionCard.tsx
│   │   ├── ProgressBar.tsx
│   │   └── index.ts
│   └── LandingPageForm/
│       └── ...
├── layout/                           # 레이아웃 컴포넌트
│   ├── Header/
│   │   ├── Header.tsx
│   │   ├── NavMenu.tsx
│   │   ├── UserMenu.tsx
│   │   └── index.ts
│   ├── Sidebar/
│   │   ├── Sidebar.tsx
│   │   ├── SidebarItem.tsx
│   │   └── index.ts
│   ├── Footer/
│   │   └── ...
│   └── DashboardLayout/
│       └── ...
├── landing-page/                     # 랜딩페이지 관련
│   ├── Editor/
│   │   ├── Editor.tsx                # TipTap 에디터
│   │   ├── Toolbar.tsx
│   │   ├── extensions/               # 커스텀 익스텐션
│   │   └── index.ts
│   ├── Preview/
│   │   ├── Preview.tsx
│   │   ├── PreviewFrame.tsx
│   │   └── index.ts
│   ├── Templates/
│   │   └── ...
│   └── Sections/                     # 랜딩페이지 섹션 컴포넌트
│       ├── HeroSection.tsx
│       ├── BenefitsSection.tsx
│       ├── TestimonialsSection.tsx
│       ├── CTASection.tsx
│       └── index.ts
├── ai/                               # AI 관련 컴포넌트
│   ├── ChatInterface/
│   │   ├── ChatInterface.tsx
│   │   ├── MessageBubble.tsx
│   │   ├── StreamingText.tsx
│   │   └── index.ts
│   └── TokenUsage/
│       ├── TokenUsage.tsx
│       ├── UsageBar.tsx
│       └── index.ts
└── common/                           # 공통 컴포넌트
    ├── ErrorBoundary/
    │   └── ...
    ├── LoadingOverlay/
    │   └── ...
    ├── ConfirmDialog/
    │   └── ...
    └── Pagination/
        └── ...
```

### 1.4 src/lib 구조

```
src/lib/
├── supabase/
│   ├── client.ts                     # 브라우저 클라이언트
│   ├── server.ts                     # 서버 클라이언트
│   ├── admin.ts                      # Admin 클라이언트 (service role)
│   └── middleware.ts                 # 미들웨어용 클라이언트
├── auth/
│   ├── tokens.ts                     # JWT 토큰 관리
│   ├── cookies.ts                    # 쿠키 유틸리티
│   ├── session.ts                    # 세션 관리
│   └── guards.ts                     # 인증 가드
├── ai/
│   ├── claude.ts                     # Claude API 클라이언트
│   ├── prompts.ts                    # 프롬프트 템플릿
│   ├── streaming.ts                  # SSE 스트리밍
│   └── tokens.ts                     # 토큰 관리 (2-Phase)
├── security/
│   ├── cors.ts                       # CORS 설정
│   ├── rate-limit.ts                 # Rate Limiting
│   ├── sanitize.ts                   # XSS 방어 (DOMPurify)
│   └── crypto.ts                     # 암호화 유틸리티
├── validators/
│   ├── auth.ts                       # 인증 스키마
│   ├── landing-page.ts               # 랜딩페이지 스키마
│   ├── qa-session.ts                 # Q&A 세션 스키마
│   └── common.ts                     # 공통 스키마
├── utils/
│   ├── date.ts                       # 날짜 유틸리티
│   ├── format.ts                     # 포맷팅 유틸리티
│   ├── error.ts                      # 에러 핸들링
│   └── logger.ts                     # 로깅 유틸리티
└── constants/
    ├── errors.ts                     # 에러 코드 상수
    ├── routes.ts                     # 라우트 상수
    └── config.ts                     # 앱 설정 상수
```

### 1.5 src/store 구조 (Zustand)

```
src/store/
├── auth.ts                           # 인증 상태
├── user.ts                           # 사용자 정보
├── landing-page.ts                   # 랜딩페이지 상태
├── qa-session.ts                     # Q&A 세션 상태
├── ui.ts                             # UI 상태 (모달, 토스트)
├── token-usage.ts                    # 토큰 사용량 상태
└── index.ts                          # 배럴 export
```

### 1.6 src/types 구조

```
src/types/
├── database.ts                       # Supabase 생성 타입
├── api.ts                            # API 요청/응답 타입
├── auth.ts                           # 인증 관련 타입
├── landing-page.ts                   # 랜딩페이지 타입
├── qa-session.ts                     # Q&A 세션 타입
├── ai.ts                             # AI 관련 타입
└── common.ts                         # 공통 타입
```

---

## 2. 네이밍 컨벤션

### 2.1 파일/폴더 네이밍

```typescript
/**
 * 파일 네이밍 규칙
 */

// 컴포넌트: PascalCase
// src/components/ui/Button/Button.tsx
// src/components/forms/LoginForm/LoginForm.tsx

// 훅: camelCase (use 접두사)
// src/hooks/useAuth.ts
// src/hooks/useLandingPage.ts

// 유틸리티/라이브러리: camelCase 또는 kebab-case
// src/lib/auth/tokens.ts
// src/lib/security/rate-limit.ts

// 타입 정의: camelCase
// src/types/auth.ts
// src/types/landing-page.ts

// 테스트 파일: 원본파일명.test.ts
// Button.test.tsx
// useAuth.test.ts

// 상수: SCREAMING_SNAKE_CASE (파일명은 camelCase)
// src/lib/constants/errors.ts
// export const AUTH_ERRORS = { ... }

// API Routes: kebab-case (폴더), route.ts (파일)
// src/app/api/auth/login/route.ts
// src/app/api/landing-pages/[id]/route.ts
```

### 2.2 코드 네이밍

```typescript
/**
 * 변수/함수 네이밍 규칙
 */

// 1. 변수: camelCase
const userName = 'John';
const isLoading = false;
const landingPageId = 'uuid';

// 2. 상수: SCREAMING_SNAKE_CASE
const MAX_TOKEN_LIMIT = 100000;
const API_ENDPOINTS = {
  AUTH_LOGIN: '/api/auth/login',
  LP_LIST: '/api/lp',
};

// 3. 함수: camelCase (동사로 시작)
function getUserProfile() {}
function createLandingPage() {}
function validateEmail() {}
async function fetchTokenUsage() {}

// 4. 이벤트 핸들러: handle 접두사
function handleSubmit() {}
function handleClick() {}
function handleInputChange() {}

// 5. Boolean: is, has, can, should 접두사
const isAuthenticated = true;
const hasPermission = false;
const canEdit = true;
const shouldRefresh = false;

// 6. 배열: 복수형
const users = [];
const landingPages = [];
const questions = [];

// 7. 타입/인터페이스: PascalCase
interface UserProfile {}
type LandingPageStatus = 'draft' | 'published';

// 8. Enum: PascalCase (값은 SCREAMING_SNAKE_CASE)
enum ErrorCode {
  AUTH_001 = 'AUTH_001',
  AUTH_002 = 'AUTH_002',
}

// 9. 제네릭: 단일 대문자 또는 의미있는 이름
function identity<T>(arg: T): T {}
function fetch<TData, TError>(url: string): Promise<TData> {}
```

### 2.3 컴포넌트 네이밍

```typescript
/**
 * React 컴포넌트 네이밍 규칙
 */

// 1. 컴포넌트: PascalCase
// Button.tsx
export function Button() {}

// 2. 컴포넌트 파일 구조
// src/components/ui/Button/
// ├── Button.tsx          // 메인 컴포넌트
// ├── Button.test.tsx     // 테스트
// ├── Button.stories.tsx  // Storybook (선택)
// └── index.ts            // 배럴 export

// 3. Props 타입: ComponentNameProps
interface ButtonProps {
  variant?: 'primary' | 'secondary';
  size?: 'sm' | 'md' | 'lg';
  children: React.ReactNode;
  onClick?: () => void;
}

export function Button({ variant = 'primary', size = 'md', children, onClick }: ButtonProps) {
  return <button className={`btn-${variant} btn-${size}`} onClick={onClick}>{children}</button>;
}

// 4. 훅 반환 타입: UseComponentNameReturn
interface UseAuthReturn {
  user: User | null;
  isLoading: boolean;
  login: (credentials: LoginCredentials) => Promise<void>;
  logout: () => Promise<void>;
}

export function useAuth(): UseAuthReturn {}

// 5. Context: ComponentNameContext
const AuthContext = createContext<AuthContextValue | null>(null);
export function AuthProvider({ children }: { children: React.ReactNode }) {}
```

---

## 3. 모듈 구조 상세

### 3.1 Supabase 클라이언트 모듈

```typescript
// src/lib/supabase/client.ts
/**
 * 브라우저 환경용 Supabase 클라이언트
 *
 * @description
 * - 클라이언트 컴포넌트에서 사용
 * - 싱글톤 패턴으로 인스턴스 관리
 * - 자동 토큰 갱신 비활성화 (직접 관리)
 */
import { createBrowserClient } from '@supabase/ssr';
import type { Database } from '@/types/database';

let client: ReturnType<typeof createBrowserClient<Database>> | null = null;

export function getSupabaseClient() {
  if (client) return client;

  client = createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      auth: {
        autoRefreshToken: false,  // 직접 관리
        persistSession: false,    // 쿠키로 관리
      },
    }
  );

  return client;
}

// src/lib/supabase/server.ts
/**
 * 서버 환경용 Supabase 클라이언트
 *
 * @description
 * - 서버 컴포넌트, API Routes에서 사용
 * - 요청마다 새 인스턴스 생성 (쿠키 기반)
 */
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import type { Database } from '@/types/database';

export async function getSupabaseServerClient() {
  const cookieStore = await cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options) {
          cookieStore.set({ name, value, ...options });
        },
        remove(name: string, options) {
          cookieStore.delete({ name, ...options });
        },
      },
    }
  );
}

// src/lib/supabase/admin.ts
/**
 * Admin 권한 Supabase 클라이언트
 *
 * @description
 * - Service Role Key 사용
 * - RLS 우회 가능
 * - 서버 사이드에서만 사용 (절대 클라이언트 노출 금지)
 */
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/database';

export function getSupabaseAdmin() {
  return createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
}
```

### 3.2 인증 모듈

```typescript
// src/lib/auth/tokens.ts
/**
 * JWT 토큰 관리 유틸리티
 *
 * @description
 * - Access Token: 메모리 저장 (15분 만료)
 * - Refresh Token: HttpOnly Cookie (7일 만료)
 */
import { jwtDecode, JwtPayload } from 'jwt-decode';

interface TokenPayload extends JwtPayload {
  sub: string;
  email: string;
  role: string;
}

/**
 * Access Token 디코딩
 */
export function decodeAccessToken(token: string): TokenPayload | null {
  try {
    return jwtDecode<TokenPayload>(token);
  } catch {
    return null;
  }
}

/**
 * Token 만료 확인
 */
export function isTokenExpired(token: string, bufferSeconds = 60): boolean {
  const decoded = decodeAccessToken(token);
  if (!decoded?.exp) return true;

  const expiresAt = decoded.exp * 1000;
  const now = Date.now();
  const buffer = bufferSeconds * 1000;

  return now >= expiresAt - buffer;
}

/**
 * Token 갱신 필요 여부 확인
 */
export function shouldRefreshToken(token: string): boolean {
  return isTokenExpired(token, 5 * 60); // 5분 전부터 갱신
}

// src/lib/auth/cookies.ts
/**
 * HttpOnly Cookie 관리 (서버 사이드)
 */
import { cookies } from 'next/headers';
import { ResponseCookie } from 'next/dist/compiled/@edge-runtime/cookies';

const REFRESH_TOKEN_COOKIE = 'refresh_token';

interface CookieOptions extends Partial<ResponseCookie> {
  maxAge?: number;
}

/**
 * Refresh Token 쿠키 설정
 */
export async function setRefreshTokenCookie(
  token: string,
  options: CookieOptions = {}
): Promise<void> {
  const cookieStore = await cookies();

  cookieStore.set(REFRESH_TOKEN_COOKIE, token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    path: '/api/auth',
    maxAge: 7 * 24 * 60 * 60, // 7일
    ...options,
  });
}

/**
 * Refresh Token 쿠키 조회
 */
export async function getRefreshTokenCookie(): Promise<string | null> {
  const cookieStore = await cookies();
  return cookieStore.get(REFRESH_TOKEN_COOKIE)?.value ?? null;
}

/**
 * Refresh Token 쿠키 삭제
 */
export async function deleteRefreshTokenCookie(): Promise<void> {
  const cookieStore = await cookies();
  cookieStore.delete({
    name: REFRESH_TOKEN_COOKIE,
    path: '/api/auth',
  });
}

// src/lib/auth/guards.ts
/**
 * 인증 가드 (API Routes용)
 */
import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseServerClient } from '@/lib/supabase/server';
import { ERROR_CODES } from '@/lib/constants/errors';

export interface AuthenticatedRequest extends NextRequest {
  userId: string;
  userEmail: string;
  userTier: string;
}

/**
 * 인증 필수 API 가드
 */
export async function withAuth(
  request: NextRequest,
  handler: (req: AuthenticatedRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  const authHeader = request.headers.get('authorization');

  if (!authHeader?.startsWith('Bearer ')) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: ERROR_CODES.AUTH_003,
          message: '인증이 필요합니다',
        },
      },
      { status: 401 }
    );
  }

  const token = authHeader.slice(7);
  const supabase = await getSupabaseServerClient();

  const { data: { user }, error } = await supabase.auth.getUser(token);

  if (error || !user) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: ERROR_CODES.AUTH_003,
          message: '세션이 만료되었습니다',
        },
      },
      { status: 401 }
    );
  }

  // 프로필 조회 (승인 상태 확인)
  const { data: profile } = await supabase
    .from('profiles')
    .select('tier, is_approved, deleted_at')
    .eq('id', user.id)
    .single();

  if (profile?.deleted_at) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: ERROR_CODES.AUTH_006,
          message: '탈퇴한 계정입니다',
        },
      },
      { status: 403 }
    );
  }

  if (!profile?.is_approved) {
    return NextResponse.json(
      {
        success: false,
        error: {
          code: ERROR_CODES.AUTH_002,
          message: '관리자 승인 대기 중입니다',
        },
      },
      { status: 403 }
    );
  }

  // 인증 정보 주입
  const authenticatedRequest = request as AuthenticatedRequest;
  authenticatedRequest.userId = user.id;
  authenticatedRequest.userEmail = user.email!;
  authenticatedRequest.userTier = profile.tier;

  return handler(authenticatedRequest);
}

/**
 * 관리자 전용 API 가드
 */
export async function withAdmin(
  request: NextRequest,
  handler: (req: AuthenticatedRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  return withAuth(request, async (req) => {
    if (req.userTier !== 'ENTERPRISE') {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: ERROR_CODES.GEN_003,
            message: '접근 권한이 없습니다',
          },
        },
        { status: 403 }
      );
    }
    return handler(req);
  });
}
```

### 3.3 보안 모듈

```typescript
// src/lib/security/sanitize.ts
/**
 * XSS 방어 유틸리티
 *
 * @description
 * - DOMPurify 기반 HTML 정화
 * - v2: ALLOWED_URI_REGEXP 강화
 */
import DOMPurify from 'dompurify';

// v2: URI 정규식 강화 (javascript: 등 차단)
const ALLOWED_URI_REGEXP = /^(?:(?:https?|mailto|tel):|[^a-z]|[a-z+.-]+(?:[^a-z+.\-:]|$))/i;

/**
 * DOMPurify 설정 (v2 강화)
 */
const DOMPURIFY_CONFIG: DOMPurify.Config = {
  ALLOWED_TAGS: [
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'p', 'span', 'div', 'br',
    'strong', 'em', 'u', 'strike',
    'ul', 'ol', 'li',
    'a', 'img',
    'blockquote', 'pre', 'code',
  ],
  ALLOWED_ATTR: [
    'href', 'src', 'alt', 'title',
    'class', 'id', 'style',
    'target', 'rel',
  ],
  ALLOWED_URI_REGEXP,
  FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover'],
  ADD_ATTR: ['target'], // 링크에 target 허용
};

/**
 * HTML 정화 (XSS 방어)
 */
export function sanitizeHtml(dirty: string): string {
  if (typeof window === 'undefined') {
    // 서버 사이드에서는 기본 이스케이프만
    return escapeHtml(dirty);
  }

  return DOMPurify.sanitize(dirty, DOMPURIFY_CONFIG);
}

/**
 * HTML 이스케이프 (기본)
 */
export function escapeHtml(text: string): string {
  const map: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
  };
  return text.replace(/[&<>"']/g, (char) => map[char]);
}

/**
 * 사용자 입력 정화 (텍스트)
 */
export function sanitizeText(input: string): string {
  return input
    .trim()
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // 제어 문자 제거
    .slice(0, 10000); // 최대 길이 제한
}

// src/lib/security/crypto.ts
/**
 * 암호화 유틸리티
 */
import { randomBytes, createHash } from 'crypto';

/**
 * 보안 랜덤 토큰 생성
 */
export function generateSecureToken(length = 64): string {
  return randomBytes(length).toString('base64url');
}

/**
 * 토큰 해시 생성 (SHA-256)
 */
export function hashToken(token: string): string {
  return createHash('sha256').update(token).digest('hex');
}

/**
 * 에러 참조 ID 생성
 */
export function generateErrorReference(): string {
  const timestamp = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14);
  const random = randomBytes(2).toString('hex').toUpperCase();
  return `ERR-${timestamp}-${random}`;
}
```

---

## 4. 환경 변수

### 4.1 환경 변수 목록

```bash
# .env.example

# ===================
# Supabase
# ===================
NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIs...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIs...

# Supabase 직접 DB 연결 (마이그레이션용)
SUPABASE_DB_HOST=aws-xxxx.pooler.supabase.com
SUPABASE_DB_PORT=6543
SUPABASE_DB_USER=postgres.xxxx
SUPABASE_DB_PASSWORD=your-db-password
SUPABASE_DB_NAME=postgres

# ===================
# Claude API
# ===================
ANTHROPIC_API_KEY=sk-ant-api03-...

# ===================
# 앱 설정
# ===================
NEXT_PUBLIC_APP_URL=https://magnetic-sales.vercel.app
NEXT_PUBLIC_APP_NAME=Magnetic Sales

# ===================
# 보안 (v2)
# ===================
# CORS 허용 도메인 (쉼표 구분)
ADDITIONAL_CORS_ORIGINS=https://staging.magnetic-sales.vercel.app

# JWT 시크릿 (Supabase 내장 사용 시 불필요)
# JWT_SECRET=your-jwt-secret

# ===================
# 모니터링 (선택)
# ===================
SENTRY_DSN=https://xxxx@sentry.io/xxxx
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...

# ===================
# 개발 환경 전용
# ===================
# NODE_ENV=development
```

### 4.2 환경별 설정

```typescript
// src/lib/constants/config.ts
/**
 * 앱 설정 상수
 */

export const APP_CONFIG = {
  name: process.env.NEXT_PUBLIC_APP_NAME || 'Magnetic Sales',
  url: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
  isDev: process.env.NODE_ENV === 'development',
  isProd: process.env.NODE_ENV === 'production',
} as const;

export const AUTH_CONFIG = {
  accessTokenExpiry: 15 * 60,        // 15분 (초)
  refreshTokenExpiry: 7 * 24 * 60 * 60, // 7일 (초)
  refreshBeforeExpiry: 5 * 60,       // 만료 5분 전 갱신
} as const;

export const TOKEN_LIMITS = {
  FREE: 100_000,
  PRO: 500_000,
  ENTERPRISE: 2_000_000,
} as const;

export const RATE_LIMITS = {
  '/api/auth/login': { limit: 5, windowSeconds: 60 },
  '/api/auth/signup': { limit: 3, windowSeconds: 60 },
  '/api/auth/refresh': { limit: 10, windowSeconds: 60 },
  '/api/ai/generate': { limit: 10, windowSeconds: 60 },
  '/api/lp': { limit: 30, windowSeconds: 60 },
  default: { limit: 60, windowSeconds: 60 },
} as const;

export const LP_CONFIG = {
  maxPagesPerUser: {
    FREE: 3,
    PRO: Infinity,
    ENTERPRISE: Infinity,
  },
  softDeleteRecoveryDays: 30,
} as const;
```

---

## 5. Import 규칙

### 5.1 Import 순서

```typescript
/**
 * Import 순서 규칙 (ESLint로 강제)
 */

// 1. React/Next.js
import { useState, useEffect } from 'react';
import { NextRequest, NextResponse } from 'next/server';
import Link from 'next/link';
import Image from 'next/image';

// 2. 외부 라이브러리
import { z } from 'zod';
import { createClient } from '@supabase/supabase-js';
import DOMPurify from 'dompurify';

// 3. 내부 라이브러리 (@/)
import { getSupabaseClient } from '@/lib/supabase/client';
import { useAuth } from '@/hooks/useAuth';
import { Button } from '@/components/ui';

// 4. 상대 경로 (같은 모듈 내)
import { validateEmail } from './validators';
import type { FormData } from './types';

// 5. 스타일
import styles from './Component.module.css';
```

### 5.2 Path Alias 설정

```json
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@/components/*": ["src/components/*"],
      "@/lib/*": ["src/lib/*"],
      "@/hooks/*": ["src/hooks/*"],
      "@/store/*": ["src/store/*"],
      "@/types/*": ["src/types/*"]
    }
  }
}
```

---

## 6. 구현 체크리스트

### 6.1 초기 설정
- [ ] Next.js 14 프로젝트 생성
- [ ] TypeScript 설정
- [ ] Tailwind CSS 설정
- [ ] ESLint/Prettier 설정
- [ ] Husky 설정 (pre-commit, pre-push)
- [ ] Path alias 설정

### 6.2 디렉토리 생성
- [ ] src/app 구조 생성
- [ ] src/components 구조 생성
- [ ] src/lib 구조 생성
- [ ] src/store 구조 생성
- [ ] src/types 구조 생성
- [ ] supabase 디렉토리 생성
- [ ] tests 디렉토리 생성

### 6.3 환경 변수
- [ ] .env.example 작성
- [ ] .env.local 설정
- [ ] Vercel 환경 변수 설정

---

**이전 문서: [00_PRD_개요.md](./00_PRD_개요.md)**
**다음 문서: [02_DB_마이그레이션.md](./02_DB_마이그레이션.md)**
